interp vec2 interp_vertex_position;

inform tex2 inform_texture;
inform tex2 inform_depth_texture;

vec2 uv = interp_vertex_position / 2 + 0.5;
flt depth = sample(inform_depth_texture, uv).r;

frozen int gaussian_kernel_size = 301;
frozen flt gaussian_kernel[gaussian_kernel_size] = flt[](0.000035, 0.000037, 0.00004, 0.000043, 0.000047, 0.00005, 0.000054, 0.000058, 0.000062, 0.000066, 0.000071, 0.000076, 0.000081, 0.000087, 0.000093, 0.0001, 0.000106, 0.000114, 0.000121, 0.000129, 0.000138, 0.000147, 0.000157, 0.000167, 0.000178, 0.000189, 0.000201, 0.000214, 0.000227, 0.000241, 0.000255, 0.000271, 0.000287, 0.000304, 0.000322, 0.000341, 0.000361, 0.000382, 0.000404, 0.000426, 0.00045, 0.000475, 0.000501, 0.000528, 0.000557, 0.000587, 0.000618, 0.00065, 0.000684, 0.000719, 0.000755, 0.000793, 0.000832, 0.000873, 0.000916, 0.00096, 0.001006, 0.001053, 0.001102, 0.001153, 0.001206, 0.00126, 0.001316, 0.001374, 0.001434, 0.001495, 0.001559, 0.001624, 0.001692, 0.001761, 0.001832, 0.001905, 0.001981, 0.002058, 0.002137, 0.002218, 0.0023, 0.002385, 0.002472, 0.002561, 0.002651, 0.002743, 0.002838, 0.002933, 0.003031, 0.003131, 0.003232, 0.003334, 0.003438, 0.003544, 0.003651, 0.00376, 0.00387, 0.003981, 0.004093, 0.004207, 0.004321, 0.004437, 0.004553, 0.00467, 0.004788, 0.004906, 0.005024, 0.005143, 0.005262, 0.005382, 0.005501, 0.00562, 0.005739, 0.005857, 0.005975, 0.006093, 0.006209, 0.006325, 0.00644, 0.006554, 0.006666, 0.006777, 0.006886, 0.006994, 0.0071, 0.007204, 0.007305, 0.007405, 0.007502, 0.007597, 0.007689, 0.007779, 0.007866, 0.007949, 0.00803, 0.008107, 0.008182, 0.008252, 0.00832, 0.008384, 0.008444, 0.0085, 0.008552, 0.008601, 0.008646, 0.008686, 0.008723, 0.008755, 0.008783, 0.008807, 0.008826, 0.008842, 0.008852, 0.008859, 0.008861, 0.008859, 0.008852, 0.008842, 0.008826, 0.008807, 0.008783, 0.008755, 0.008723, 0.008686, 0.008646, 0.008601, 0.008552, 0.0085, 0.008444, 0.008384, 0.00832, 0.008252, 0.008182, 0.008107, 0.00803, 0.007949, 0.007866, 0.007779, 0.007689, 0.007597, 0.007502, 0.007405, 0.007305, 0.007204, 0.0071, 0.006994, 0.006886, 0.006777, 0.006666, 0.006554, 0.00644, 0.006325, 0.006209, 0.006093, 0.005975, 0.005857, 0.005739, 0.00562, 0.005501, 0.005382, 0.005262, 0.005143, 0.005024, 0.004906, 0.004788, 0.00467, 0.004553, 0.004437, 0.004321, 0.004207, 0.004093, 0.003981, 0.00387, 0.00376, 0.003651, 0.003544, 0.003438, 0.003334, 0.003232, 0.003131, 0.003031, 0.002933, 0.002838, 0.002743, 0.002651, 0.002561, 0.002472, 0.002385, 0.0023, 0.002218, 0.002137, 0.002058, 0.001981, 0.001905, 0.001832, 0.001761, 0.001692, 0.001624, 0.001559, 0.001495, 0.001434, 0.001374, 0.001316, 0.00126, 0.001206, 0.001153, 0.001102, 0.001053, 0.001006, 0.00096, 0.000916, 0.000873, 0.000832, 0.000793, 0.000755, 0.000719, 0.000684, 0.00065, 0.000618, 0.000587, 0.000557, 0.000528, 0.000501, 0.000475, 0.00045, 0.000426, 0.000404, 0.000382, 0.000361, 0.000341, 0.000322, 0.000304, 0.000287, 0.000271, 0.000255, 0.000241, 0.000227, 0.000214, 0.000201, 0.000189, 0.000178, 0.000167, 0.000157, 0.000147, 0.000138, 0.000129, 0.000121, 0.000114, 0.000106, 0.0001, 0.000093, 0.000087, 0.000081, 0.000076, 0.000071, 0.000066, 0.000062, 0.000058, 0.000054, 0.00005, 0.000047, 0.000043, 0.00004, 0.000037, 0.000035);

vec4 colour = vec4(0.0);

int width = 800;
int height = 480;

int radius = int((abs(-500.0f * 0.1f / (depth * (500.0f - 0.1f) - 500.0f) - 1.0f) + 1.0) * 2);
if (depth == 1.0) radius = 70;
for (int i = 0; i < radius * 2; i++) {
	colour += sample(inform_texture, vec2(uv.s, uv.t + flt(i - radius) / height)) * gaussian_kernel[int(flt(i) / flt(radius * 2) * gaussian_kernel_size)] * (flt(gaussian_kernel_size) / (radius * 2)); // * gl_Color;
	
}

colour.a = 1.0;
return colour;
