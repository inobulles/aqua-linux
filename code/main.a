
import lib/video.a
import lib/events.a
import lib/device.a
import lib/math.a

import lib/devices/input/mouse.a
import lib/devices/input/joystick.a
import lib/devices/io/fs.a

import lib/devices/graphics/surface.a

var data;
var bytes;

if (Fs.read("root/bird.png", &data, &bytes)) {
	print "Failed to read\n";
}

var result = Device.send("png", 0x64, data, bytes);

var bitmap = ?(result + 00);
var bit_depth = ?(result + 08);
var width = ?(result + 16);
var height = ?(result + 24);

Texture.filter(0x52);
Texture->var texture = new(Texture).construct(bitmap, bit_depth, width, height);
mfree data, bytes;

Surface->var surface = new(Surface).construct();
surface.texture texture;




print "Count " ++ str(Joystick.count()) ++ "\n";

Joystick->var joystick = new(Joystick).construct(1);
print "Joystick " ++ joystick.name() ++ "\n";

Mouse->var mouse = new(Mouse).construct(0);
print "Mouse " ++ mouse.name() ++ "\n";

print "Sinh 1.234567: " ++ str(?Device.send("math", 0x686E6973, 1234567)) ++ "\n";
print "Hello world, video_width = " ++ str(video_width()) ++ ", video_height = " ++ str(video_height()) ++ "\n";

var events = new(Events);

loop {
	Video.clear Math.abs(mouse.axis(0)), Math.abs(mouse.axis(1)), mouse.axis(2) / 2 + 500000, 1000000;
	surface.scroll Math.abs(joystick.axis(0)) * 2, Math.abs(joystick.axis(1)) * 2, Math.abs(joystick.axis(2)) * 2, Math.abs(joystick.axis(3)) * 2;
	surface.draw 0, 0, 0;
	Video.flip();
	
	events.get();
	if (events.quit) break
}

return 1337;
